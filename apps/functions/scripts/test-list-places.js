/**
 * TEST LIST PLACES - PINUBI FUNCTIONS
 *
 * Este script testa especificamente a funcionalidade de adicionar lugares √†s listas
 * para verificar se as corre√ß√µes nas regras de seguran√ßa do Firestore funcionaram.
 *
 * Usage: node ./scripts/test-list-places.js (with emulators running)
 */

// Imports necess√°rios
const admin = require("firebase-admin");
const { initializeApp: initializeClientApp } = require("firebase/app");
const {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  connectAuthEmulator,
} = require("firebase/auth");
const {
  getFirestore: getClientFirestore,
  connectFirestoreEmulator,
  collection,
  doc,
  setDoc,
  addDoc,
  getDocs,
  query,
  where,
} = require("firebase/firestore");
const {
  getFunctions,
  httpsCallable,
  connectFunctionsEmulator,
} = require("firebase/functions");

// Configura√ß√£o dos emuladores
process.env.FIRESTORE_EMULATOR_HOST = "localhost:8080";
process.env.FIREBASE_AUTH_EMULATOR_HOST = "localhost:9099";
process.env.FIREBASE_FUNCTIONS_EMULATOR_HOST = "localhost:5001";

// Inicializar Firebase Admin
const adminApp = admin.initializeApp({
  projectId: "demo-pinubi-functions",
});
const db = admin.firestore(adminApp);
const authAdmin = admin.auth(adminApp);

// Inicializar Firebase Client
const clientFirebaseConfig = {
  projectId: "demo-pinubi-functions",
  apiKey: "AIzaSyDemoApiKeyForEmulatorUsage123456789",
  authDomain: "demo-pinubi-functions.firebaseapp.com",
  storageBucket: "demo-pinubi-functions.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456",
};

const clientApp = initializeClientApp(clientFirebaseConfig);
const clientAuth = getAuth(clientApp);
const clientDb = getClientFirestore(clientApp);
const clientFunctions = getFunctions(clientApp);

// Conectar aos emuladores
connectAuthEmulator(clientAuth, "http://localhost:9099");
connectFirestoreEmulator(clientDb, "localhost", 8080);
connectFunctionsEmulator(clientFunctions, "localhost", 5001);

// ======================
// CORES E UTILIT√ÅRIOS
// ======================

const colors = {
  reset: "\x1b[0m",
  bright: "\x1b[1m",
  red: "\x1b[31m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  blue: "\x1b[34m",
  magenta: "\x1b[35m",
  cyan: "\x1b[36m",
};

function logTest(message) {
  console.log(`${colors.cyan}üß™ ${message}${colors.reset}`);
}

function logSuccess(message) {
  console.log(`${colors.green}‚úÖ ${message}${colors.reset}`);
}

function logError(message, error = null) {
  console.log(`${colors.red}‚ùå ${message}${colors.reset}`);
  if (error) {
    console.error(
      `${colors.red}   Error details: ${error.message || error}${colors.reset}`
    );
  }
}

function logInfo(message) {
  console.log(`${colors.blue}‚ÑπÔ∏è  ${message}${colors.reset}`);
}

function logSection(title) {
  console.log(`\n${colors.yellow}${"=".repeat(60)}`);
  console.log(`${colors.yellow}${title}${colors.reset}`);
  console.log(`${colors.yellow}${"=".repeat(60)}${colors.reset}\n`);
}

function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

// ======================
// SETUP DE DADOS
// ======================

async function setupTestData() {
  logSection("SETUP DE DADOS BASE");

  const timestamp = Date.now();
  const testUser = {
    email: `test-list-user-${timestamp}@pinubi-test.com`,
    password: "TestListUser123!",
    displayName: `Test List User ${timestamp}`,
  };

  try {
    // Criar usu√°rio de teste
    logTest(`Criando usu√°rio: ${testUser.email}`);
    
    const userCredential = await createUserWithEmailAndPassword(
      clientAuth,
      testUser.email,
      testUser.password
    );

    const userId = userCredential.user.uid;
    logSuccess(`Usu√°rio criado com UID: ${userId}`);

    // Aguardar trigger criar documento
    await sleep(2000);

    // Ativar usu√°rio para os testes
    await db.collection("users").doc(userId).set({
      id: userId,
      email: testUser.email,
      displayName: testUser.displayName,
      accountType: "free",
      isValidated: true,
      isActive: true,
      onboardingComplete: true,
      validatedAt: new Date(),
      listsCount: 0,
      placesCount: 0,
      createdAt: new Date(),
      updatedAt: new Date(),
    }, { merge: true });

    logSuccess("Usu√°rio ativado para os testes");

    // Fazer login
    await signInWithEmailAndPassword(clientAuth, testUser.email, testUser.password);
    logSuccess("Login realizado com sucesso");

    // Criar uma lista de teste
    logTest("Criando lista de teste");
    
    const listData = {
      id: `test-list-${timestamp}`,
      name: `Test List ${timestamp}`,
      description: "Lista de teste para verificar adi√ß√£o de lugares",
      visibility: "public",
      ownerId: userId,
      collaborators: [],
      editors: [],
      placesCount: 0,
      isActive: true,
      createdAt: new Date(),
      updatedAt: new Date(),
    };

    await db.collection("lists").doc(listData.id).set(listData);
    logSuccess(`Lista criada: ${listData.name} (ID: ${listData.id})`);

    // Criar um lugar de teste
    logTest("Criando lugar de teste");
    
    const placeData = {
      id: `test-place-${timestamp}`,
      name: `Test Place ${timestamp}`,
      description: "Lugar de teste para adicionar √† lista",
      category: "restaurant",
      coordinates: new admin.firestore.GeoPoint(-23.5505, -46.6333),
      address: "Test Address, S√£o Paulo, SP",
      isActive: true,
      createdAt: new Date(),
      createdBy: userId,
    };

    await db.collection("places").doc(placeData.id).set(placeData);
    logSuccess(`Lugar criado: ${placeData.name} (ID: ${placeData.id})`);

    return {
      success: true,
      userId,
      testUser,
      listData,
      placeData,
    };

  } catch (error) {
    logError("Erro durante setup de dados:", error);
    return { success: false, error };
  }
}

// ======================
// TESTE DE ADI√á√ÉO DE LUGAR √Ä LISTA
// ======================

async function testAddPlaceToList(setupResult) {
  logSection("TESTE: ADICIONAR LUGAR √Ä LISTA");

  if (!setupResult.success) {
    logError("Setup falhou, pulando teste");
    return { success: false };
  }

  try {
    const { userId, listData, placeData } = setupResult;

    // Teste 1: Adicionar lugar √† lista via Firestore Client
    logTest("Testando adi√ß√£o direta via Firestore Client");

    const listPlaceData = {
      listId: listData.id,
      placeId: placeData.id,
      addedBy: userId,
      addedAt: new Date(),
      order: 0,
      notes: "Lugar adicionado via teste automatizado",
    };

    // Tentar adicionar o lugar √† lista
    const listPlacesRef = collection(clientDb, "listPlaces");
    const docRef = await addDoc(listPlacesRef, listPlaceData);
    
    logSuccess(`Lugar adicionado √† lista com sucesso! DocID: ${docRef.id}`);

    // Verificar se foi salvo corretamente
    await sleep(1000);
    
    const addedDocQuery = query(
      collection(clientDb, "listPlaces"),
      where("listId", "==", listData.id),
      where("placeId", "==", placeData.id)
    );
    
    const querySnapshot = await getDocs(addedDocQuery);
    
    if (!querySnapshot.empty) {
      logSuccess("‚úÖ Lugar encontrado na lista ap√≥s adi√ß√£o");
      
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        logInfo(`- Lista: ${data.listId}`);
        logInfo(`- Lugar: ${data.placeId}`);
        logInfo(`- Adicionado por: ${data.addedBy}`);
        logInfo(`- Notas: ${data.notes}`);
      });
    } else {
      logError("‚ùå Lugar n√£o foi encontrado na lista ap√≥s adi√ß√£o");
      return { success: false };
    }

    // Teste 2: Tentar adicionar o mesmo lugar novamente (deve funcionar para lugares diferentes)
    logTest("Testando adi√ß√£o de um segundo lugar");

    const placeData2 = {
      id: `test-place-2-${Date.now()}`,
      name: `Test Place 2 ${Date.now()}`,
      description: "Segundo lugar de teste",
      category: "cafe",
      coordinates: new admin.firestore.GeoPoint(-23.5507, -46.6335),
      address: "Test Address 2, S√£o Paulo, SP",
      isActive: true,
      createdAt: new Date(),
      createdBy: userId,
    };

    await db.collection("places").doc(placeData2.id).set(placeData2);

    const listPlaceData2 = {
      listId: listData.id,
      placeId: placeData2.id,
      addedBy: userId,
      addedAt: new Date(),
      order: 1,
      notes: "Segundo lugar adicionado via teste",
    };

    const docRef2 = await addDoc(listPlacesRef, listPlaceData2);
    logSuccess(`Segundo lugar adicionado com sucesso! DocID: ${docRef2.id}`);

    // Verificar quantos lugares est√£o na lista agora
    const allPlacesQuery = query(
      collection(clientDb, "listPlaces"),
      where("listId", "==", listData.id)
    );
    
    const allPlacesSnapshot = await getDocs(allPlacesQuery);
    logSuccess(`‚úÖ Total de lugares na lista: ${allPlacesSnapshot.size}`);

    if (allPlacesSnapshot.size === 2) {
      logSuccess("‚úÖ Ambos os lugares foram adicionados corretamente");
      return { success: true };
    } else {
      logError(`‚ùå Esperado 2 lugares, encontrado ${allPlacesSnapshot.size}`);
      return { success: false };
    }

  } catch (error) {
    logError("Erro ao adicionar lugar √† lista:", error);
    return { success: false, error };
  }
}

// ======================
// LIMPEZA DE DADOS
// ======================

async function cleanupTestData(setupResult) {
  logSection("LIMPEZA DE DADOS DE TESTE");

  if (!setupResult.success) {
    logInfo("Nenhum dado para limpar");
    return;
  }

  try {
    const { userId, listData, placeData } = setupResult;

    // Deletar listPlaces
    const listPlacesQuery = await db.collection("listPlaces")
      .where("listId", "==", listData.id)
      .get();
    
    for (const doc of listPlacesQuery.docs) {
      await doc.ref.delete();
    }
    logSuccess("ListPlaces removidos");

    // Deletar lista
    await db.collection("lists").doc(listData.id).delete();
    logSuccess("Lista removida");

    // Deletar lugar(s)
    await db.collection("places").doc(placeData.id).delete();
    
    // Deletar segundo lugar se existir
    const placesQuery = await db.collection("places")
      .where("createdBy", "==", userId)
      .get();
    
    for (const doc of placesQuery.docs) {
      await doc.ref.delete();
    }
    logSuccess("Lugares removidos");

    // Deletar usu√°rio
    await authAdmin.deleteUser(userId);
    await db.collection("users").doc(userId).delete();
    logSuccess("Usu√°rio de teste removido");

  } catch (error) {
    logError("Erro durante limpeza:", error);
  }
}

// ======================
// FUN√á√ÉO PRINCIPAL
// ======================

async function runListPlacesTest() {
  console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                      ‚ïë
‚ïë     üß™ TESTE DE LIST PLACES - PINUBI                ‚ïë
‚ïë                                                      ‚ïë
‚ïë     Verificando se a corre√ß√£o nas regras de         ‚ïë
‚ïë     seguran√ßa do Firestore funcionou                ‚ïë
‚ïë                                                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`);

  let setupResult = null;

  try {
    // Setup de dados base
    setupResult = await setupTestData();

    if (setupResult.success) {
      // Executar teste principal
      const testResult = await testAddPlaceToList(setupResult);

      if (testResult.success) {
        logSection("‚úÖ TESTE PASSOU!");
        console.log(`${colors.green}üéâ A corre√ß√£o das regras funcionou!${colors.reset}`);
        console.log(`${colors.green}‚úÖ Lugares podem ser adicionados √†s listas sem erro!${colors.reset}`);
      } else {
        logSection("‚ùå TESTE FALHOU");
        console.log(`${colors.red}üí• Ainda h√° problemas com as regras de seguran√ßa${colors.reset}`);
      }
    }

    // Limpeza
    if (setupResult) {
      await cleanupTestData(setupResult);
    }

  } catch (error) {
    logError("Erro cr√≠tico durante execu√ß√£o do teste:", error);
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  runListPlacesTest().catch((error) => {
    console.error("Erro fatal:", error);
    process.exit(1);
  });
}

module.exports = { runListPlacesTest };
