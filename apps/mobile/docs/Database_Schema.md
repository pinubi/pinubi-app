# Esquema de Banco de Dados - Pinubi

## Estrutura Geral

O banco de dados utiliza Firebase Firestore com as seguintes cole√ß√µes principais:

## 1. Cole√ß√£o `users`

```javascript
// Documento: userId
{
  id: "user123",
  email: "user@example.com",
  displayName: "Jo√£o Silva",
  photoURL: "https://example.com/photo.jpg",
  accountType: "free", // "free" | "premium"
  profileVisibility: "public", // "public" | "private"

  // Sistema de Convites e Ativa√ß√£o
  inviteCode: "ABC123", // C√≥digo √∫nico do usu√°rio (6 chars alfanum√©rico)
  maxInvites: 5, // M√°ximo de convites permitidos
  invitesUsed: 2, // Quantidade j√° utilizada
  invitedBy: "user456", // Quem convidou este usu√°rio
  invitedUsers: ["user789", "user101"], // Array de IDs dos usu√°rios convidados

  // Estados de Valida√ß√£o e Ativa√ß√£o
  isValidated: true, // Se passou pela valida√ß√£o do convite
  isActive: true, // Se est√° ativo e pode usar o app
  onboardingComplete: true, // Se completou todo o processo
  validatedAt: "2025-01-01T10:00:00Z", // Quando foi validado

  // M√©tricas e Limites
  listsCount: 3,
  placesCount: 25,
  aiCredits: 5, // Cr√©ditos atuais para IA
  aiCreditsLastReset: "2025-01-01T00:00:00Z",
  votationsThisMonth: 1,

  // Configura√ß√µes
  preferences: {
    categories: ["japanese", "italian", "burgers"],
    priceRange: [1, 3], // 1-4 escala
    dietaryRestrictions: ["vegetarian"]
  },

  // Relacionamentos
  following: ["user456", "user789"], // Usu√°rios que este usu√°rio segue
  followers: ["user101", "user202"], // Usu√°rios que seguem este usu√°rio
  pendingFriendRequests: ["user303"], // Solicita√ß√µes pendentes

  // Timestamps
  createdAt: "2025-01-01T00:00:00Z",
  lastLoginAt: "2025-01-15T14:30:00Z",

  // Localiza√ß√£o
  location: {
    country: "Brazil",
    state: "SP",
    city: "S√£o Paulo",
    coordinates: {
      lat: -23.5505,
      lng: -46.6333
    }
  },

  // GeoFirestore - Para buscas de usu√°rios por proximidade (opcional)
  geoLocation: {
    coordinates: new admin.firestore.GeoPoint(-23.5505, -46.6333), // GeoPoint do Firestore
    g: {
      geohash: "6gkzmb1u", // Hash geogr√°fico
      geopoint: new admin.firestore.GeoPoint(-23.5505, -46.6333)
    }
  }
}
```

## 2. Cole√ß√£o `lists`

```javascript
// Documento: listId
{
  id: "list123",
  title: "Melhores Japon√™s SP",
  emoji: "üç£",
  description: "Os melhores restaurantes japoneses que j√° visitei",

  // Propriet√°rio e Permiss√µes
  ownerId: "user123",
  visibility: "public", // "public" | "private"
  editors: [
    {
      userId: "user456",
      permission: "edit", // "view" | "edit"
      addedAt: "2025-01-10T00:00:00Z"
    }
  ],

  // Monetiza√ß√£o
  isMonetized: false,
  price: 0, // Em centavos (BRL)
  purchasedBy: ["user789"], // Array de usu√°rios que compraram

  // Metadados
  placesCount: 15,
  tags: ["japanese", "sushi", "sao-paulo"],
  category: "restaurants",

  // M√©tricas (apenas para listas monetizadas)
  metrics: {
    views: 150,
    purchases: 3,
    revenue: 2970, // Em centavos
    dailyViews: 5,
    weeklyViews: 25,
    monthlyViews: 100
  },

  // Listas Autom√°ticas (criadas na ativa√ß√£o)
  isSystemList: false, // true para "Recomenda√ß√µes da Pinubi"
  isAutoGenerated: false, // true para "Quero Visitar" e "Favoritas"
  canDelete: true, // false para listas autom√°ticas
  canRename: true, // false para listas autom√°ticas
  autoListType: "", // "want_to_visit" | "favorites"

  // Timestamps
  createdAt: "2025-01-01T00:00:00Z",
  updatedAt: "2025-01-15T12:00:00Z",

  // Localiza√ß√£o para filtros
  regions: ["SP", "S√£o Paulo"] // Para filtros por regi√£o
}
```

## 3. Cole√ß√£o `places`

```javascript
// Documento: placeId (Google Place ID)
{
  id: "ChIJN1t_tDeuEmsRUsoyG83frY4", // Google Place ID

  // Dados do Google Maps
  googleData: {
    name: "Sushi Yasuda",
    address: "Rua Augusta, 123 - S√£o Paulo, SP",
    coordinates: {
      lat: -23.5505,
      lng: -46.6333
    },
    phone: "+5511999999999",
    website: "https://sushiyasuda.com.br",
    rating: 4.5,
    userRatingsTotal: 1250,
    photos: ["photo_id_1", "photo_id_2"],
    types: ["restaurant", "food", "establishment"],
    priceLevel: 3, // 0-4
    openingHours: {
      weekdayText: ["Segunda: 18:00‚Äì23:00", "..."]
    },
    lastUpdated: "2025-01-15T00:00:00Z"
  },

  // Cache e Performance
  searchableText: "sushi yasuda restaurant japanese s√£o paulo augusta", // Para busca

  // GeoFirestore - Dados geogr√°ficos para consultas de proximidade
  coordinates: new admin.firestore.GeoPoint(-23.5505, -46.6333), // GeoPoint do Firestore
  g: {
    geohash: "6gkzmb1u", // Hash geogr√°fico para consultas eficientes
    geopoint: new admin.firestore.GeoPoint(-23.5505, -46.6333)
  },

  // Metadados da Plataforma
  addedBy: ["user123", "user456"], // Usu√°rios que adicionaram este lugar
  totalAdds: 2,
  categories: ["japanese", "sushi", "restaurant"],

  // Timestamps
  createdAt: "2025-01-01T00:00:00Z",
  lastGoogleSync: "2025-01-15T00:00:00Z"
}
```

## 4. Cole√ß√£o `listPlaces`

```javascript
// Documento: listId_placeId
{
  id: "list123_place456",
  listId: "list123",
  placeId: "place456",

  // Metadados
  addedBy: "user123",
  addedAt: "2025-01-10T15:30:00Z",
  order: 1, // Ordem na lista

  // Notas personalizadas
  personalNote: "Melhor sushi que j√° comi!",
  tags: ["date-night", "expensive"]
}
```

## 5. Cole√ß√£o `reviews`

```javascript
// Documento: reviewId
{
  id: "review123",
  userId: "user123",
  placeId: "place456",

  // Avalia√ß√£o
  rating: 8.5, // 0-10
  wouldReturn: true,
  reviewType: "food", // "food" | "drink" | "dessert" | "service" | "ambiance"

  // Conte√∫do
  comment: "Sushi excelente, atendimento impec√°vel!",
  photos: [
    {
      url: "https://r2.cloudflare.com/images/review123_1.jpg",
      thumbnail: "https://r2.cloudflare.com/images/review123_1_thumb.jpg"
    }
  ],

  // Status
  isVisited: true,
  visitDate: "2025-01-05T19:00:00Z",

  // Timestamps
  createdAt: "2025-01-06T10:00:00Z",
  updatedAt: "2025-01-06T10:00:00Z"
}
```

## 6. Cole√ß√£o `follows`

```javascript
// Documento: followerId_followingId
{
  id: "user123_user456",
  followerId: "user123", // Quem segue
  followingId: "user456", // Quem √© seguido
  status: "active", // "active" | "pending" | "blocked"
  createdAt: "2025-01-01T00:00:00Z"
}
```

## 7. Cole√ß√£o `activities`

```javascript
// Documento: activityId
{
  id: "activity123",
  userId: "user123",
  type: "place_added", // "place_added" | "place_visited" | "place_reviewed" | "list_purchased" | "match_created" | "user_invited" | "account_upgraded" | "profile_visibility_changed"

  // Dados espec√≠ficos por tipo
  data: {
    placeId: "place456",
    listId: "list123",
    placeName: "Sushi Yasuda",
    rating: 8.5
  },

  // Visibilidade
  isPublic: true,

  // Timestamps
  createdAt: "2025-01-15T16:00:00Z"
}
```

## 8. Cole√ß√£o `matches`

```javascript
// Documento: matchId
{
  id: "match123",
  createdBy: "user123",
  title: "Top 3 Japon√™s para o fim de semana",
  description: "Vamos escolher onde ir no s√°bado!",

  // Configura√ß√µes
  category: "japanese",
  participants: ["user123", "user456", "user789"],

  // Resultados
  suggestions: [
    {
      placeId: "place456",
      placeName: "Sushi Yasuda",
      votes: 2,
      votedBy: ["user123", "user456"]
    }
  ],

  // Status
  status: "active", // "active" | "completed" | "expired"
  shareLink: "https://pinubi.app/match/ABC123",
  notifyParticipants: true,

  // Timestamps
  createdAt: "2025-01-15T10:00:00Z",
  expiresAt: "2025-01-22T10:00:00Z"
}
```

## 9. Cole√ß√£o `votations`

```javascript
// Documento: votationId
{
  id: "votation123",
  createdBy: "user123",
  title: "Onde almo√ßar hoje?",
  description: "Escolham o restaurante para o almo√ßo da equipe",

  // Configura√ß√µes
  allowSuggestions: true,
  votesPerPerson: 1,
  shareLink: "https://pinubi.app/vote/XYZ789",

  // Op√ß√µes
  options: [
    {
      placeId: "place456",
      placeName: "Sushi Yasuda",
      addedBy: "user123",
      votes: 3,
      votedBy: ["user123", "user456", "user789"]
    }
  ],

  // Status
  status: "active", // "active" | "completed" | "expired"

  // Timestamps
  createdAt: "2025-01-15T08:00:00Z",
  expiresAt: "2025-01-15T12:00:00Z"
}
```

## 10. Cole√ß√£o `purchases`

```javascript
// Documento: purchaseId
{
  id: "purchase123",
  userId: "user123",
  listId: "list456",

  // Pagamento
  stripePaymentIntentId: "pi_abc123",
  amount: 990, // Em centavos
  currency: "brl",
  status: "completed", // "pending" | "completed" | "failed" | "refunded"

  // Dados do vendedor
  sellerId: "user789",
  sellerRevenue: 792, // 80% do valor
  platformFee: 198, // 20% do valor

  // Snapshot da lista (preservar conte√∫do)
  listSnapshot: {
    title: "Melhores Japon√™s SP",
    places: [...], // Array com os lugares no momento da compra
    createdAt: "2025-01-01T00:00:00Z"
  },

  // Timestamps
  createdAt: "2025-01-15T14:00:00Z"
}
```

## 11. Cole√ß√£o `notifications`

```javascript
// Documento: notificationId
{
  id: "notification123",
  userId: "user123", // Destinat√°rio
  type: "friend_request", // "friend_request" | "match_created" | "list_purchased" | "vote_created"

  // Dados espec√≠ficos
  data: {
    fromUserId: "user456",
    fromUserName: "Maria Silva",
    message: "Maria Silva enviou uma solicita√ß√£o de amizade"
  },

  // Estado
  isRead: false,

  // Timestamps
  createdAt: "2025-01-15T16:30:00Z",
  readAt: null
}
```

## 12. Cole√ß√£o `aiPrompts`

```javascript
// Documento: promptId
{
  id: "prompt123",
  userId: "user123",

  // Prompt e Resposta
  prompt: "Sugira 5 restaurantes japoneses em S√£o Paulo para um encontro rom√¢ntico",
  response: "Baseado nas suas prefer√™ncias, aqui est√£o 5 sugest√µes...",

  // Configura√ß√µes
  creditsUsed: 1,

  // Contexto usado
  userPreferences: {...},
  userLocation: {...},
  userHistory: [...],

  // Resultados
  suggestedPlaces: ["place123", "place456"],
  placesAddedToList: ["place123"],

  // Timestamps
  createdAt: "2025-01-15T11:00:00Z"
}
```

## 13. Cole√ß√£o `invites`

````javascript
## 13. Cole√ß√£o `invites` (REMOVIDA - Sistema simplificado)

**NOTA**: O sistema de convites foi simplificado. Cada usu√°rio possui seu pr√≥prio c√≥digo √∫nico armazenado no campo `inviteCode` da cole√ß√£o `users`. N√£o h√° mais necessidade de uma cole√ß√£o separada para convites.

## 14. Cole√ß√£o `profiles`

```javascript
// Documento: userId (mesmo ID do usu√°rio)
{
  id: "user123",
  userId: "user123",
  displayName: "Jo√£o Silva",
  email: "user@example.com",

  // Status
  isActive: true,
  profileComplete: true,

  // Contadores (atualizados por triggers)
  followersCount: 150,
  followingCount: 89,
  listsCount: 12,
  placesCount: 245,
  reviewsCount: 67,

  // Timestamps
  createdAt: "2025-01-01T00:00:00Z",
  updatedAt: "2025-01-15T14:30:00Z"
}
````

## 15. Cole√ß√£o `user-settings`

```javascript
// Documento: userId (mesmo ID do usu√°rio)
{
  id: "user123",
  userId: "user123",

  // Notifica√ß√µes
  notifications: {
    email: true,
    push: true,
    sms: false,
    newFollower: true,
    listPurchased: true,
    socialMatch: true,
    votation: true
  },

  // Privacidade
  privacy: {
    profilePublic: true, // Free sempre true, Premium pode alterar
    showEmail: false,
    allowInvites: true
  },

  // Prefer√™ncias
  theme: "light", // "light" | "dark" | "auto"
  language: "pt-BR",

  // Timestamps
  createdAt: "2025-01-01T00:00:00Z",
  updatedAt: "2025-01-15T14:30:00Z"
}
```

````

## √çndices Recomendados

### Cole√ß√£o `users`

- `accountType` (para queries por tipo de conta)
- `inviteCode` (√∫nico, para valida√ß√£o de convites)
- `following` (array, para feed de atividades)
- `isValidated` (para controle de acesso)
- `isActive` (para usu√°rios ativos)
- Composto: `isValidated` + `isActive` (para usu√°rios com acesso completo)

### Cole√ß√£o `lists`

- `ownerId` (para listas do usu√°rio)
- `visibility` (para listas p√∫blicas)
- `tags` (array, para filtros)
- `isMonetized` (para marketplace)
- `createdAt` (para ordena√ß√£o)
- `isAutoGenerated` (para listas autom√°ticas)
- Composto: `ownerId` + `isAutoGenerated` (para listas autom√°ticas do usu√°rio)

### Cole√ß√£o `places`

- `addedBy` (array, para hist√≥rico do usu√°rio)
- `googleData.coordinates` (geohash, para queries geogr√°ficas)
- `searchableText` (para busca textual)
- `categories` (array, para filtros)
- `g.geohash` (√≠ndice geogr√°fico do GeoFirestore)

### Cole√ß√£o `listPlaces`

- `listId` (para lugares de uma lista)
- `placeId` (para listas que cont√™m um lugar)
- `addedBy` (para hist√≥rico do usu√°rio)
- Composto: `listId` + `order` (para ordena√ß√£o)

### Cole√ß√£o `reviews`

- `userId` (para reviews do usu√°rio)
- `placeId` (para reviews de um lugar)
- `createdAt` (para ordena√ß√£o)
- Composto: `placeId` + `reviewType` (para tipos espec√≠ficos)

### Cole√ß√£o `activities`

- `userId` (para feed do usu√°rio)
- `type` (para filtros por tipo)
- `createdAt` (para ordena√ß√£o cronol√≥gica)
- `isPublic` (para atividades vis√≠veis)

### Cole√ß√£o `follows`

- `followerId` (para quem o usu√°rio segue)
- `followingId` (para seguidores de um usu√°rio)
- `status` (para relacionamentos ativos)

## GeoFirestore - Consultas Geogr√°ficas

### Configura√ß√£o

O GeoFirestore √© utilizado para realizar consultas de proximidade eficientes nos dados geogr√°ficos. Os campos necess√°rios s√£o automaticamente adicionados quando um documento √© salvo com coordenadas.

### Estrutura dos Dados Geogr√°ficos

```javascript
// Campo adicionado automaticamente pelo GeoFirestore
{
  coordinates: new admin.firestore.GeoPoint(latitude, longitude),
  g: {
    geohash: "6gkzmb1u", // Hash geogr√°fico para consultas eficientes
    geopoint: new admin.firestore.GeoPoint(latitude, longitude)
  }
}
````

### Exemplos de Uso

#### Buscar lugares pr√≥ximos

```javascript
import { GeoFirestore } from "geofirestore";

const geoFirestore = new GeoFirestore(admin.firestore());
const geocollection = geoFirestore.collection("places");

// Buscar lugares em um raio de 10km
const query = geocollection.near({
  center: new admin.firestore.GeoPoint(-23.5505, -46.6333),
  radius: 10, // km
});

const snapshot = await query.get();
```

#### Buscar usu√°rios pr√≥ximos (opcional)

```javascript
// Para funcionalidades sociais - usu√°rios pr√≥ximos
const usersCollection = geoFirestore.collection("users");

const nearbyUsers = usersCollection.near({
  center: new admin.firestore.GeoPoint(userLat, userLng),
  radius: 5, // km
});
```

### Performance

- O GeoFirestore usa geohashes para criar consultas eficientes
- √çndices compostos n√£o s√£o necess√°rios para consultas geogr√°ficas
- As consultas s√£o limitadas a ~100 resultados por consulta para performance
- Para resultados maiores, use pagina√ß√£o com `startAfter()`
